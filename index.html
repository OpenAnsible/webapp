<!DOCTYPE html>
<html lang="zh_CN">
<head>
    
    <meta name="renderer" content="webkit|ie-comp|ie-stand" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta charset="utf-8" />
    <meta name="keywords" 
            content="OpenAnsible, Ansible, WebRTC, LiveCast, WebLive, WebCast, Zhibo, LiveChat, 直播, 安塞波" />
    <meta name="description" content="OpenAnsible Web Application." />

    <title>OpenAnsible Web Application</title>

    <link rel="stylesheet" type="text/css" href="assets/css/bootstrap.min.css" />
    <link rel="stylesheet" type="text/css" href="assets/css/bootstrap-theme.min.css" />
    <link rel="stylesheet" type="text/css" href="assets/css/common.css" />
    <link rel="stylesheet" type="text/css" href="assets/css/main.css" />

    <script type="text/javascript" src="assets/js/jquery/jquery-1.12.3.min.js"></script>

    <!-- WebRTC 跨浏览器API兼容库 -->
    <script type="text/javascript" src="assets/js/adapter-latest.js"></script>
    <script type="text/javascript" src="assets/js/webrtc.js"></script>

    <script type="text/javascript" src="assets/js/elm.js"></script>
</head>

<body>
    <div id="elm-container">

    </div>

    
    <div class="panel panel-default">
        <div class="panel-heading">
            <h3 class="panel-title">Face Time</h3>
        </div>
        <div class="panel-body">
            <div class="left" style="float: left">
                <video style="float: left" width=300 
                    id="localVideo" autoplay muted></video>
                <video style="float: left" width=600 
                    id="remoteVideo" autoplay></video>
            </div>
            <div class="right" style="float: right">
                <h3>Peers <button class="btn btn-info" id="fetchPeers"
                            onClick="javascript:fetch_peers();">刷新</button> </h3>
                <ul class="list-group" id="peers">
                    
                </ul>
            </div>
        </div>
    </div>

    <div class="panel panel-default" style="padding-bottom: 60px;">
        <div class="panel-heading">
            <h3 class="panel-title">Text Chat</h3>
        </div>
        <div class="panel-body" id="logs">
            <ul class="list-group">
                <li class="list-group-item">
                    <p><span>57be05946434316769b8897d</span>:<code>hello</code></p>
                </li>
                <li class="list-group-item">
                    <p><span>57be05946434316769b8897d</span>:<code>Hi</code></p>
                </li>
            </ul>
            <div class="btn-group" role="group">
                <div class="row">
                    <div class="col-lg-6">
                        <div class="input-group">
                          <input type="text" 
                            class="form-control" 
                            id="message_input"
                            placeholder="message ..." />
                        
                          <span class="input-group-btn">
                            <button class="btn btn-default" 
                                id="callButton"
                                type="button"
                                onClick="javascript:send();">Send</button>
                          </span>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
</body>

<script type="text/javascript">
    Elm.Main.embed(document.getElementById('elm-container'));
    // Elm.Main.fullscreen();
</script>


<script type="text/javascript">

var servers      = { "iceServers": [ {"urls": ["stun:104.155.239.54:3478" ] } ] };
var offerOptions = { "offerToReceiveAudio": 1, "offerToReceiveVideo": 1 };
    
window.peer = new RTCPeerConnection(servers);
window.peer.onaddstream = function (e) {
    document.getElementById('remoteVideo').srcObject = e.stream;
};

var socket = new WebSocket("ws://104.155.239.54:3012", []);

socket.onmessage = function (event) {
    var msg = JSON.parse(event.data);
    if ( msg.id == 'fetch_peers' ) {
        return this.onnames( msg.result );
    }

    if ( msg.event == 'sdp' ) {
        var _sdp = JSON.parse(msg.content);
        var sdp  = new RTCSessionDescription();
        sdp.type = _sdp.type;
        sdp.sdp  = _sdp.sdp;

        if ( sdp.type == 'offer' ) {
            window.peer.setRemoteDescription(sdp, 
                function() {
                    window.peer.createAnswer(function (desc){
                        // send_answer(from, desc);
                        window.peer.setLocalDescription(desc, function(){
                            var _msg = {
                                "id": "send_answer", "event": "sdp", 
                                "target": msg.from, "content": JSON.stringify(window.peer.localDescription) 
                            };
                            socket.send(JSON.stringify(_msg));
                            self_view();
                        }, function (){

                        });
                    }, function (err){
                        console.error(err);
                    });
                }, function (err){
                    console.error(err);
                }
            );
        } else if ( sdp.type == 'answer' ){
            window.peer.setRemoteDescription(sdp, function (e){
                console.info("recevived answer.");
                console.log(e)
            }, function (err){

            });
        }
    } else if ( msg.event == 'candidate' ) {
        // addIceCandidate
        if ( msg.content === 'null' ) msg.content = null;

        var candidate = new RTCIceCandidate( JSON.parse(msg.content) );
        window.peer.addIceCandidate(candidate, function (){}, function (){});
    }
};
socket.onnames = function (result){
    var peers = result;
    var peers_dom = peers.map(function (peer_id, i){
        return $(
            '<li class="list-group-item" data-peer_id="#PEER_ID#">#PEER_ID#<button class="btn btn-success" onclick="javascript:Call.bind(this)(\'#PEER_ID#\');">Call</button> </li>'
            .replace("#PEER_ID#", peer_id)
            .replace("#PEER_ID#", peer_id)
            .replace("#PEER_ID#", peer_id)
        );
    })
    $("#peers").empty().append(peers_dom);
};

function send() {
    var input = document.getElementById("message_input");
    socket.send(input.value);
    input.value = "";
}

function fetch_peers(){
    socket.send(JSON.stringify({"id": "fetch_peers", "event": "cmd", "content": "peers"}));
}

function self_view(){
    window.navigator.mediaDevices.getUserMedia({"audio": true, "video": true})
        .then(function (stream){
            document.getElementById('localVideo').srcObject = stream;
            // if (stream.getAudioTracks().length > 0)
            //     window.peer.addTrack(stream.getAudioTracks()[0], stream);
            // if (stream.getVideoTracks().length > 0)
            //     window.peer.addTrack(stream.getVideoTracks()[0], stream);
            window.peer.addStream(stream);
        }).catch(function(e) {
            console.error(e);
        });
}
function Call(peer_id){
    self_view();

    window.peer.onicecandidate = function(e) {
        if (!e || !e.candidate) return;
        var msg = {
            "id": "candidate", "event": "candidate", "target": peer_id,
            "content": JSON.stringify(e.candidate)
        };
        socket.send(JSON.stringify(msg));
    };

    window.peer.onnegotiationneeded = function (e){
        console.info("createOffer ...");
        window.peer.createOffer(function (desc){
            window.peer.setLocalDescription(desc, 
                function() {
                    var msg = {
                        "id": "send_offer", "event": "sdp", 
                        "target": peer_id, "content": JSON.stringify(window.peer.localDescription) 
                    };
                    socket.send(JSON.stringify(msg));
                }, function (err){
                    console.error(err);
                }
            );
        }, function (err){
            console.error(err);
        }, offerOptions);
    };

    
}
setTimeout(fetch_peers, 1000);
</script>
</html>
